## SpecStory

## 优惠卷功能开发与代码检查 (4/5/2025, 7:40:41 AM)

_**User**_

帮我查看一下目前的优惠卷部分的代码 然后帮我把http://localhost:3000/cart?cart_id=14 购物车结算或者Product结算链接到 后端的优惠卷controller 然后新建一个功能来验证当前购买的物品是否可以使用优惠卷 然后每一样的物品扣除金额多少 是否达到上限或者下限 你可以先查看优惠卷相关的代码

---

_**Assistant**_

我会帮您检查优惠券部分代码并建立购物车与优惠券功能的连接。首先让我查看相关代码文件。

---

_****_

<details>
            <summary>Searched codebase "coupon" • **10** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

_****_

让我先看看优惠券的模型和控制器结构：

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

现在，让我查看一下购物车相关的代码：

---

_****_

<details>
            <summary>Searched codebase "cart" • **10** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

让我查看前端的购物车页面代码：

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

让我查找前端API服务相关代码：

---

_****_

Read file: undefined

---

_****_

让我看一下前端如何处理优惠券：

---

_****_

<details>
            <summary>Searched codebase "couponApply" • **0** results</summary>
        
No results found
</details>

---

_****_

<details>
            <summary>Searched codebase "coupon+apply" • **0** results</summary>
        
No results found
</details>

---

_****_

<details>
            <summary>Searched codebase "apply coupon" • **10** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

_****_

<details>
            <summary>Searched codebase "checkout" • **9** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

让我查看一下更多的结算页面代码，特别是优惠券部分：

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

通过以上代码分析，我们可以看到系统中已有优惠券相关的功能，但前端与后端的优惠券验证连接需要完善。现在我们需要创建一个新的验证功能来检查当前商品是否可以使用优惠券以及计算每个商品的折扣金额。

让我为您创建一个实现方案：

---

_****_

```diff
  use App\Models\CouponTemplate;
  use App\Models\SalesOrder;
+ use App\Models\Cart;
+ use App\Models\CartItem;
+ use App\Services\CouponService;
  use Illuminate\Http\RedirectResponse;
  use Illuminate\Http\Request;
  use Illuminate\View\View;
+ use Illuminate\Http\JsonResponse;
  
  class CouponController extends Controller
          ]);
      }
+ 
+     /**
+      * Validate coupon for cart items
+      * 
+      * @param Request $request
+      * @return JsonResponse
+      */
+     public function validateCartCoupon(Request $request): JsonResponse
+     {
+         $request->validate([
+             'coupon_code' => 'required|string',
+             'cart_id' => 'required|integer|exists:carts,id',
+         ]);
+ 
+         $couponCode = $request->coupon_code;
+         $cartId = $request->cart_id;
+ 
+         // Find the coupon
+         $coupon = Coupon::where('code', $couponCode)
+             ->where('user_id', auth()->id())
+             ->where('status', 'active')
+             ->first();
+ 
+         if (!$coupon) {
+             return response()->json([
+                 'success' => false,
+                 'message' => 'The coupon does not exist or has been used'
+             ], 404);
+         }
+ 
+         // Check if the coupon is valid
+         if (!$coupon->template->isValid()) {
+             return response()->json([
+                 'success' => false,
+                 'message' => 'Coupon expired'
+             ], 400);
+         }
+ 
+         // Get the cart with items
+         $cart = Cart::with(['items.product'])->findOrFail($cartId);
+ 
+         // Check if cart belongs to the current user
+         if ($cart->user_id !== auth()->id()) {
+             return response()->json([
+                 'success' => false,
+                 'message' => 'Unauthorized access to the cart'
+             ], 403);
+         }
+ 
+         // Check minimum amount requirement
+         $cartTotal = $cart->total();
+         if ($cartTotal < $coupon->template->min_amount) {
+             return response()->json([
+                 'success' => false,
+                 'message' => "Order minimum amount requirement not met. Minimum amount: {$coupon->template->min_amount}"
+             ], 400);
+         }
+ 
+         // Get coupon service to handle complex validation and discount calculation
+         $couponService = new CouponService();
+ 
+         // Check if any coupon restrictions exist and if the cart meets them
+         $restrictions = $coupon->template->restrictions;
+         $validItems = [];
+         $invalidItems = [];
+         $itemDiscounts = [];
+         $totalDiscount = 0;
+ 
+         // If there are no restrictions, all items are valid
+         if ($restrictions->isEmpty()) {
+             // Calculate discount for each item
+             foreach ($cart->items as $item) {
+                 $itemTotal = $item->price * $item->quantity;
+                 $itemDiscount = $this->calculateItemDiscount($coupon, $itemTotal, $cartTotal);
+                 
+                 $itemDiscounts[] = [
+                     'item_id' => $item->id,
+                     'product_id' => $item->product_id,
+                     'product_name' => $item->product->name ?? 'Product',
+                     'quantity' => $item->quantity,
+                     'original_price' => $item->price,
+                     'discount' => $itemDiscount,
+                     'final_price' => $item->price - ($itemDiscount / $item->quantity)
+                 ];
+                 
+                 $totalDiscount += $itemDiscount;
+                 $validItems[] = $item->id;
+             }
+         } else {
+             // Check each item against restrictions
+             foreach ($cart->items as $item) {
+                 $itemValid = false;
+                 
+                 foreach ($restrictions as $restriction) {
+                     $restrictionType = $restriction->restriction_type;
+                     $restrictionValue = $restriction->restriction_value;
+                     
+                     // Product restriction
+                     if ($restrictionType === 'product' && $item->product_id == $restrictionValue) {
+                         $itemValid = true;
+                         break;
+                     }
+                     
+                     // Category restriction
+                     if ($restrictionType === 'category' && $item->product->category_id == $restrictionValue) {
+                         $itemValid = true;
+                         break;
+                     }
+                 }
+                 
+                 if ($itemValid) {
+                     $validItems[] = $item->id;
+                     $itemTotal = $item->price * $item->quantity;
+                     $itemDiscount = $this->calculateItemDiscount($coupon, $itemTotal, $cartTotal);
+                     
+                     $itemDiscounts[] = [
+                         'item_id' => $item->id,
+                         'product_id' => $item->product_id,
+                         'product_name' => $item->product->name ?? 'Product',
+                         'quantity' => $item->quantity,
+                         'original_price' => $item->price,
+                         'discount' => $itemDiscount,
+                         'final_price' => $item->price - ($itemDiscount / $item->quantity)
+                     ];
+                     
+                     $totalDiscount += $itemDiscount;
+                 } else {
+                     $invalidItems[] = $item->id;
+                 }
+             }
+         }
+ 
+         // Check if the total discount exceeds the maximum allowed discount
+         if ($coupon->template->max_discount && $totalDiscount > $coupon->template->max_discount) {
+             $reductionRatio = $coupon->template->max_discount / $totalDiscount;
+             $totalDiscount = $coupon->template->max_discount;
+             
+             // Adjust individual item discounts
+             foreach ($itemDiscounts as &$discount) {
+                 $discount['discount'] *= $reductionRatio;
+                 $discount['final_price'] = $discount['original_price'] - ($discount['discount'] / $discount['quantity']);
+             }
+         }
+ 
+         return response()->json([
+             'success' => true,
+             'coupon' => [
+                 'code' => $coupon->code,
+                 'type' => $coupon->template->type,
+                 'value' => $coupon->template->value,
+                 'min_amount' => $coupon->template->min_amount,
+                 'max_discount' => $coupon->template->max_discount,
+             ],
+             'valid_items' => $validItems,
+             'invalid_items' => $invalidItems,
+             'item_discounts' => $itemDiscounts,
+             'total_discount' => $totalDiscount,
+             'cart_total_before_discount' => $cartTotal,
+             'cart_total_after_discount' => $cartTotal - $totalDiscount
+         ]);
+     }
+ 
+     /**
+      * Calculate discount for a single item
+      */
+     private function calculateItemDiscount(Coupon $coupon, float $itemTotal, float $cartTotal): float
+     {
+         $template = $coupon->template;
+         
+         // For fixed discount, distribute proportionally based on item price
+         if ($template->type === 'fixed') {
+             return ($itemTotal / $cartTotal) * $template->value;
+         }
+         
+         // For percentage discount, apply directly
+         if ($template->type === 'percentage') {
+             return $itemTotal * ($template->value / 100);
+         }
+         
+         return 0;
+     }
  } 
```

---

_****_

现在需要添加前端API路由，让我们在路由文件中添加新的路由：

---

_****_

<details>
            <summary>Searched codebase "routes/api.php" • **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---

_****_

Read file: undefined

---

_****_

让我添加新的API路由用于优惠券验证：

---

_****_

```diff
  use App\Http\Controllers\Api\UserController;
  use App\Http\Controllers\Api\CartController;
+ use App\Http\Controllers\CouponController;
  
  /*
      // 优惠券接口
      Route::post('/apply-coupon', [App\Http\Controllers\Api\CartController::class, 'applyCoupon']);
+     Route::post('/validate-coupon', [App\Http\Controllers\CouponController::class, 'validateCartCoupon']);
  });
  
```

---

_****_

现在，让我们在前端添加相应的优惠券验证服务：

---

_****_

```diff
    }
  };
+ 
+ /**
+  * 验证优惠券是否可用于购物车中的商品
+  * @param code 优惠券代码
+  * @param cartId 购物车ID
+  */
+ export const validateCoupon = async (code: string, cartId: number) => {
+   try {
+     const response = await apiService.post('/api/cart/validate-coupon', {
+       coupon_code: code,
+       cart_id: cartId
+     });
+     
+     if (response.data.success) {
+       toast.success('Coupon validated successfully');
+     }
+     
+     return response.data;
+   } catch (error: any) {
+     console.error('Failed to validate coupon:', error);
+     const errorMsg = error.response?.data?.message || 'Failed to validate coupon';
+     toast.error(errorMsg);
+     throw error;
+   }
+ };
  
  /**
    createCart,
    applyCoupon,
+   validateCoupon,
    clearCartCache,
    exitCart
```

---

_****_

现在我们需要更新前端的结账页面，添加优惠券验证和应用逻辑：

---

_****_

```diff
  import { useState, useEffect } from 'react';
- import { useNavigate } from 'react-router-dom';
+ import { useNavigate, useLocation } from 'react-router-dom';
  import { toast } from 'react-toastify';
  import { useAppSelector, useAppDispatch } from '../store';
  import { clearCart } from '../store/slices/cartSlice';
  import { useSelector } from 'react-redux';
  import { RootState } from '../store';
+ import cartService from '../services/cartService';
  
  interface ShippingInfo {
    cvv: string;
  }
+ 
+ // 优惠券验证结果接口
+ interface CouponValidation {
+   success: boolean;
+   coupon?: {
+     code: string;
+     type: string;
+     value: number;
+     min_amount: number;
+     max_discount: number;
+   };
+   valid_items: number[];
+   invalid_items: number[];
+   item_discounts: {
+     item_id: number;
+     product_id: number;
+     product_name: string;
+     quantity: number;
+     original_price: number;
+     discount: number;
+     final_price: number;
+   }[];
+   total_discount: number;
+   cart_total_before_discount: number;
+   cart_total_after_discount: number;
+ }
  
  const CheckoutPage = () => {
    const { isAuthenticated, loading } = useSelector((state: RootState) => state.auth);
    const navigate = useNavigate();
+   const location = useLocation();
    const dispatch = useAppDispatch();
-   const { items, total } = useAppSelector(state => state.cart);
+   const { carts, activeCartId, items, total } = useAppSelector(state => state.cart);
    const [isLoading, setIsLoading] = useState(false);
    const [step, setStep] = useState(1);
    const [shippingMethod, setShippingMethod] = useState('standard');
    const [paymentMethod, setPaymentMethod] = useState('credit_card');
+   
+   // 添加优惠券相关状态
+   const [couponCode, setCouponCode] = useState('');
+   const [validatingCoupon, setValidatingCoupon] = useState(false);
+   const [couponValidation, setCouponValidation] = useState<CouponValidation | null>(null);
+   const [appliedCoupon, setAppliedCoupon] = useState<string | null>(null);
+   
+   // 解析URL参数获取cart_id
+   const query = new URLSearchParams(location.search);
+   const cartId = query.get('cart_id') ? parseInt(query.get('cart_id')!) : activeCartId;
    
    const [shippingInfo, setShippingInfo] = useState<ShippingInfo>({
    const taxRate = 0.08; // 8% tax
    const taxAmount = subtotal * taxRate;
-   const orderTotal = subtotal + shippingCost + taxAmount;
+   // 添加优惠券折扣到总计
+   const discountAmount = couponValidation?.total_discount || 0;
+   const orderTotal = subtotal + shippingCost + taxAmount - discountAmount;
    
    useEffect(() => {
      }
    };
+   
+   // 优惠券验证处理
+   const handleValidateCoupon = async () => {
+     if (!couponCode.trim()) {
+       toast.error('Please enter a coupon code');
+       return;
+     }
+     
+     if (!cartId) {
+       toast.error('Cart information not available');
+       return;
+     }
+     
+     try {
+       setValidatingCoupon(true);
+       const validation = await cartService.validateCoupon(couponCode, cartId);
+       setCouponValidation(validation);
+       
+       if (validation.success) {
+         setAppliedCoupon(couponCode);
+         toast.success(`Coupon applied! You saved $${validation.total_discount.toFixed(2)}`);
+       }
+     } catch (error) {
+       console.error('Coupon validation failed:', error);
+       setCouponValidation(null);
+       setAppliedCoupon(null);
+     } finally {
+       setValidatingCoupon(false);
+     }
+   };
+   
+   // 移除优惠券
+   const handleRemoveCoupon = () => {
+     setCouponValidation(null);
+     setAppliedCoupon(null);
+     setCouponCode('');
+     toast.info('Coupon removed');
+   };
    
    // 如果认证状态仍在加载，显示加载状态
            <div className="bg-white rounded-lg shadow-md p-6 sticky top-4">
              <h2 className="text-xl font-semibold mb-4">Order Summary</h2>
+             
+             {/* 添加优惠券输入区域 */}
+             <div className="mb-4 border-b pb-4">
+               <label className="block text-sm font-medium text-gray-700 mb-1">
+                 Promo Code
+               </label>
+               <div className="flex space-x-2">
+                 <input
+                   type="text"
+                   className="form-input flex-1 py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
+                   placeholder="Enter code"
+                   value={couponCode}
+                   onChange={(e) => setCouponCode(e.target.value)}
+                   disabled={!!appliedCoupon}
+                 />
+                 {!appliedCoupon ? (
+                   <button
+                     className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
+                     onClick={handleValidateCoupon}
+                     disabled={validatingCoupon || !couponCode.trim()}
+                   >
+                     {validatingCoupon ? (
+                       <span className="flex items-center">
+                         <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
+                           <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
+                           <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
+                         </svg>
+                         Applying
+                       </span>
+                     ) : (
+                       'Apply'
+                     )}
+                   </button>
+                 ) : (
+                   <button
+                     className="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
+                     onClick={handleRemoveCoupon}
+                   >
+                     Remove
+                   </button>
+                 )}
+               </div>
+               
+               {/* 显示已应用的优惠券信息 */}
+               {appliedCoupon && couponValidation && (
+                 <div className="mt-2 text-sm text-green-600">
+                   <p className="flex items-center">
+                     <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
+                       <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"></path>
+                     </svg>
+                     Coupon "{appliedCoupon}" applied
+                   </p>
+                   <p className="mt-1">
+                     {couponValidation.coupon?.type === 'percentage' 
+                       ? `${couponValidation.coupon.value}% off` 
+                       : `$${couponValidation.coupon?.value} off`}
+                   </p>
+                 </div>
+               )}
+             </div>
              
              <div className="space-y-3 mb-6">
                  <span>${taxAmount.toFixed(2)}</span>
                </div>
+               
+               {/* 显示折扣行 */}
+               {discountAmount > 0 && (
+                 <div className="flex justify-between text-green-600">
+                   <span>Discount</span>
+                   <span>-${discountAmount.toFixed(2)}</span>
+                 </div>
+               )}
+               
                <div className="border-t pt-3 mt-3">
                  <div className="flex justify-between font-bold">
```

---

_****_



最后，让我们在CartPage中也添加优惠券应用功能：

---

_****_

Cancelled

---

_****_



---



---

