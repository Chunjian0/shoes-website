# Apache VirtualHost Configuration for Laravel Application using PHP-FPM
#
# File: /etc/httpd/conf.d/assignment.conf (Example Path - adjust as needed)
#
# 说明:
# 1. 用此文件内容替换你服务器上对应的 Apache 站点配置文件。
# 2. 仔细检查并确认所有路径 (LARAVEL_ROOT, PHP_FPM_SOCKET) 是否正确。
# 3. 确保 Apache 加载了必要的模块: mod_proxy, mod_proxy_fcgi, mod_rewrite。
#    (通常在 CentOS/RHEL 上默认加载, Debian/Ubuntu 可能需要 a2enmod proxy proxy_fcgi rewrite)
# 4. 确保你的 Laravel 应用根目录下 `public/.htaccess` 文件存在且正确。
# 5. 修改配置后, 重启 Apache: sudo systemctl restart httpd (或 apache2)

<VirtualHost *:80>
    # --- Server Identification (Optional but Recommended) ---
    # ServerName your-domain.com
    # ServerAlias www.your-domain.com

    # --- Paths Configuration ---
    # 使用 Define 指令方便修改路径
    Define LARAVEL_ROOT /home/ec2-user/https---github.com-imethankhoooo-optic-system
    Define LARAVEL_PUBLIC ${LARAVEL_ROOT}/public
    # !! 确认 PHP-FPM Socket 路径是否正确 !!
    Define PHP_FPM_SOCKET unix:/var/run/php-fpm/www.sock

    # 设置网站根目录为 Laravel 的 public 文件夹
    DocumentRoot "${LARAVEL_PUBLIC}"

    # --- Logging ---
    # 建议为每个虚拟主机设置独立的日志文件
    ErrorLog /var/log/httpd/assignment-error.log
    CustomLog /var/log/httpd/assignment-access.log combined

    # --- Directory Settings for Public Root ---
    <Directory "${LARAVEL_PUBLIC}">
        # -Indexes: 出于安全考虑，通常禁用目录列表
        # +FollowSymLinks: 如果应用或其依赖使用了符号链接，则需要开启
        Options +FollowSymLinks -Indexes -MultiViews

        # !! 关键 !! 允许 public 目录下的 .htaccess 文件生效
        # Laravel 依赖 .htaccess 来将请求路由到 index.php
        AllowOverride All

        # Apache 2.4+ 访问控制
        Require all granted
    </Directory>
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://${PHP_FPM_SOCKET}"
    </FilesMatch>
    # --- Public Storage Alias ---
    # 直接提供对 storage/app/public 目录的访问 (用于存储链接的文件)
    Alias /storage ${LARAVEL_ROOT}/storage/app/public
    <Directory "${LARAVEL_ROOT}/storage/app/public">
        Require all granted
        # storage 目录通常不需要 .htaccess
        AllowOverride None
        # 允许读取文件和跟随符号链接
        Options +Indexes +FollowSymLinks
        # (可选) 为这些静态资源添加浏览器缓存头
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 1 month"
        </IfModule>
        <IfModule mod_headers.c>
             Header set Cache-Control "public"
        </IfModule>
    </Directory>

    <Directory "${LARAVEL_ROOT}/storage">
         <RequireAll>
             Require all denied
         </RequireAll>
    </Directory>
     <Directory "${LARAVEL_ROOT}/vendor">
         <RequireAll>
             Require all denied
         </RequireAll>
    </Directory>
    # 拒绝访问 .git 目录
     <Directory "${LARAVEL_ROOT}/.git">
         <RequireAll>
             Require all denied
         </RequireAll>
    </Directory>
     <Files ~ "^\\.ht">
        Require all denied
    </Files>
    <Files ".env">
        Require all denied
    </Files>

</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet 